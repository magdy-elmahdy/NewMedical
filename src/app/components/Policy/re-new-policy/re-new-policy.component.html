<div id="convert-to-policy">
    <div class="container">
        <div class="outerBorder shadow_5 outerItem ">
            <div id="loading" *ngIf="loading">
                <app-spinner class="d-flex justify-content-center m-auto"></app-spinner>
            </div>
            <mat-horizontal-stepper linear #stepper>
                <!--------------------------- Offer ----------------------->
                    <mat-step label="{{'Offer.Offer'|translate}}" [completed]="this.MainForm.get('InceptionDate')?.status=='VALID'&&
                    this.MainForm.get('ExpiryDate')?.status=='VALID'&&this.MainForm.get('PaymentPeriod')?.status=='VALID'&&
                    this.MainForm.get('TpaFees')?.status=='VALID'&&this.MainForm.get('Brokerage')?.status=='VALID'">
                <form [formGroup]="MainForm">
                    <div class="row my-2">  
                        <!-- Company Title -->
                        <div class="col-md-12">
                            <div class="row">
                                <div class="col-md-4">
                                    <mat-form-field class="w-100" style="margin-bottom: -1em!important">
                                        <mat-label>{{'Shared.CompanyName'|translate}}</mat-label>
                                        <input disabled type="text" readonly value="Misr Takaful Insurance" matInput>
                                        <mat-icon matIconSuffix style="color: rgba(0, 0, 0, 0.65);"> <i class="fa-regular fa-building"></i></mat-icon>
                                    </mat-form-field>
                                </div>
                                <div class="col-md-4">
                                    <mat-form-field class="w-100" style="margin-bottom: -1em!important">
                                        <mat-label>{{'Offer.Insured'|translate}}</mat-label>
                                        <input disabled type="text" readonly value="{{this.ThePolicy?.insuredName}}" matInput>
                                        <mat-icon matIconSuffix style="color: rgba(0, 0, 0, 0.65);"> <i class="fa-regular fa-user"></i></mat-icon>
                                    </mat-form-field>
                                </div>
                                <div class="col-md-4">
                                    <mat-form-field class="w-100" style="margin-bottom: -1em!important">
                                        <mat-label>{{'Offer.TpaName'|translate}}</mat-label>
                                        <input disabled type="text" readonly value="{{this.ThePolicy?.tpaName}}" matInput>
                                        <mat-icon matIconSuffix style="color: rgba(0, 0, 0, 0.65);"> <i class="fa-regular fa-user"></i></mat-icon>
                                    </mat-form-field>
                                </div>
                                
                            </div>
                        </div>
                        <!-- col 1 -->
                        <div class="col-md-3">
                            
                            <mat-form-field class="w-100" style="margin-bottom: -1em!important">
                                <mat-label>{{'Offer.InsuranceClass'|translate}}</mat-label>
                                <input disabled type="text" readonly value="{{this.ThePolicy?.insuranceClass}}" matInput>
                            </mat-form-field>

                        </div>
                        <!-- col 2 -->
                        <div class="col-md-3">
                            
                            <mat-form-field class="w-100" style="margin-bottom: -1em!important">
                                <mat-label>{{'Offer.BusinessType'|translate}}</mat-label>
                                <input disabled type="text" readonly value="{{this.ThePolicy?.businessType}}" matInput>
                            </mat-form-field>
                            
                        </div>
                        <!-- col 3 -->
                        <div class="col-md-3">
                            <mat-form-field class="w-100" style="margin-bottom: -1em!important">
                                <mat-label>{{'Offer.PolicySource'|translate}}</mat-label>
                                <input disabled type="text" readonly value="{{this.ThePolicy?.policySource}}" matInput>
                            </mat-form-field>


                        </div>
                        <div class="col-md-3">
                            <mat-form-field *ngIf="this.ThePolicy?.brokerId!=0" class="w-100" style="margin-bottom: -1em!important">
                                <mat-label>{{'Offer.Broker'|translate}}</mat-label>
                                <input disabled type="text" readonly value="{{this.ThePolicy?.brokerName}}" matInput>
                            </mat-form-field>
                        </div>
                        <div class="row">
                            <div class="col-md-3">
                                <mat-form-field class="w-100" style="margin-bottom: -1em!important">
                                    <mat-label>{{'Policy.UY'|translate}}</mat-label>
                                    <input disabled type="text" readonly value="{{this.MainForm.get('InceptionDate')?.value|date:'yyyy'}}" matInput>
                                </mat-form-field>
                            </div>
                            
                            <div class="col-md-3">
                                <mat-form-field class="w-100" style="margin-bottom: -1em!important">
                                    <mat-label>Old {{'Policy.IssueDate'|translate}}</mat-label>
                                    <input disabled readonly value="{{this.ThePolicy?.issueDate|date:'dd-MM-YYYY'}}" matInput>
                                </mat-form-field>
                            </div>
                            <div class="col-md-3">
                                <mat-form-field class="w-100" style="margin-bottom: -1em!important">
                                    <mat-label>Old {{'Policy.InceptionDate'|translate}}</mat-label>
                                    <input disabled readonly value="{{this.ThePolicy?.inceptionDate|date:'dd-MM-YYYY'}}" matInput>
                                </mat-form-field>
                            </div>
                            <div class="col-md-3">
                                <mat-form-field class="w-100" style="margin-bottom: -1em!important">
                                    <mat-label>Old {{'Policy.ExpiryDate'|translate}}</mat-label>
                                    <input disabled readonly value="{{this.ThePolicy?.expiryDate|date:'dd-MM-YYYY'}}" matInput>
                                </mat-form-field>
                            </div>
                            <!-- <div class="col-md-3">
                                <mat-form-field class="w-100">
                                    <mat-label>{{'Policy.IssueDate'|translate}}</mat-label>
                                    <input value="{{this.today|date:'yyyy-MM-dd'}}" matInput>
                                </mat-form-field>
                            </div> -->
                            
                        </div>
                            <!-- col 1 Edit -->
                        <div class="col-md-6">
                            <mat-form-field class="w-100" style="margin-bottom:-1em!important">
                                <mat-label>Branch</mat-label>
                                <mat-select formControlName="BranchId">
                                    <mat-option *ngFor="let item of AllBranches" [value]="item.id">{{item.name}}</mat-option>
                                </mat-select>
                                <mat-icon matIconSuffix style="color: rgba(0, 0, 0, 0.65);"> <i class="fa-regular fa-user"></i></mat-icon>
                            </mat-form-field>

                            <mat-form-field  class="w-100" style="margin-bottom: -1em!important">
                                <mat-label>{{'addCustomer.TaxNo'|translate}}</mat-label>
                                <input formControlName="TaxNo" type="number" matInput>
                            </mat-form-field>

                            <mat-form-field class="w-100" style="margin-bottom: -1em!important">
                                <mat-label>{{'Policy.IssueDate'|translate}}</mat-label>
                                <input [min]="this.today" formControlName="IssueDate" matInput [matDatepicker]="picker15">
                                <mat-datepicker-toggle matIconSuffix [for]="picker15"></mat-datepicker-toggle>
                                <mat-datepicker #picker15></mat-datepicker>
                            </mat-form-field>

                            <mat-form-field  style="margin-bottom: -1em!important" class="w-100">
                                <mat-label>{{'Policy.InceptionDate'|translate}}</mat-label>
                                <input [min]="this.minInceptionDate" formControlName="InceptionDate"
                                
                                (dateChange)="getInceptionDate($event)"
                                 matInput [matDatepicker]="picker1">
                                <mat-datepicker-toggle matIconSuffix [for]="picker1"></mat-datepicker-toggle>
                                <mat-datepicker #picker1></mat-datepicker>
                            </mat-form-field>
                            
                            <mat-form-field class="w-100" style="margin-bottom: -1em!important">
                                <mat-label>{{'Policy.ExpiryDate'|translate}}</mat-label>
                                <input (dateChange)="checkExpiryDate($event)"
                                 [min]="this.MinExpiryDate" formControlName="ExpiryDate" matInput [matDatepicker]="picker2">
                                <mat-datepicker-toggle matIconSuffix [for]="picker2"></mat-datepicker-toggle>
                                <mat-datepicker #picker2></mat-datepicker>
                            </mat-form-field>

                        </div>
                        <!-- col 2 Edit --> 
                        <div class="col-md-6">
                            

                            <mat-form-field  class="w-100" style="margin-bottom: -1em!important">
                                <mat-label>{{'addCustomer.RegNo'|translate}}</mat-label>
                                <input formControlName="RegNo" type="number" matInput>
                            </mat-form-field>

                            <mat-form-field class="w-100" style="margin-bottom: -1em!important">
                                <mat-label>{{'Policy.PaymentPeriod'|translate}}</mat-label>
                                <mat-select formControlName="PaymentPeriod" (selectionChange)="getPaymentPeriod($event.value)">
                                <mat-option [value]="0">Yearly</mat-option>
                                <mat-option [value]="1">Half Yearly</mat-option>
                                <mat-option [value]="2">Quarterly</mat-option>
                                </mat-select>
                                <mat-icon matIconSuffix style="color: rgba(0, 0, 0, 0.6);"><i class="fa-solid fa-money-bill"></i></mat-icon>
                            </mat-form-field>

                            
                            <mat-form-field class="w-100" style="margin-bottom: -1em!important">
                                <mat-label>{{'SideBar.TpaFees'|translate}}</mat-label>
                                <input formControlName="TpaFees" max="{{this.ThePolicy?.tpaFeesPCT}}"  type="number" matInput>
                                <mat-icon matIconSuffix style="color: rgba(0, 0, 0, 0.65);"> <i class="fa-solid fa-percent"></i></mat-icon>
                            </mat-form-field>

                            <mat-form-field class="w-100" style="margin-bottom: -1em!important" >
                                <mat-label>{{'Offer.Brokerage'|translate}}</mat-label>
                                <input formControlName="Brokerage" type="number" max="{{this.ThePolicy?.brokerage}}" matInput>
                                <mat-icon matIconSuffix style="color: rgba(0, 0, 0, 0.65);"> <i class="fa-solid fa-percent"></i></mat-icon>
                            </mat-form-field>
                            <div>
                                <label class="fs-6 text-muted">{{'Offer.UpoadSignedOffer'|translate}}</label>
                                <input accept=".pdf" (change)="uploadPdfFile($event)" class="form-control py-2" type="file">
                            </div>
                            
                        </div>
                    </div>
                            <!-- تواريــخ الســـداد -->
                    <div class="row">
                            <!-- 1 -->
                        <div class="col-md-3">
                            <mat-form-field style="display: none;" class="w-100 payment1">
                                <mat-label>{{'Policy.paymentDate1'|translate}}</mat-label>
                                <input formControlName="Settlement1" matInput [matDatepicker]="picker6">
                                <mat-datepicker-toggle matIconSuffix [for]="picker6"></mat-datepicker-toggle>
                                <mat-datepicker #picker6></mat-datepicker>
                            </mat-form-field>
                        </div>
                        <!-- 2 -->
                        <div class="col-md-3">
                            <mat-form-field style="display: none;" class="w-100 payment2">
                                <mat-label>{{'Policy.paymentDate2'|translate}}</mat-label>
                                <input formControlName="Settlement2" matInput [matDatepicker]="picker8">
                                <mat-datepicker-toggle matIconSuffix [for]="picker8"></mat-datepicker-toggle>
                                <mat-datepicker #picker8></mat-datepicker>
                            </mat-form-field>
                        </div>

                        <!-- 3 -->
                        <div class="col-md-3">
                            <mat-form-field style="display: none;" class="w-100 payment3">
                                <mat-label>{{'Policy.paymentDate3'|translate}}</mat-label>
                                <input formControlName="Settlement3" matInput [matDatepicker]="picker9">
                                <mat-datepicker-toggle matIconSuffix [for]="picker9"></mat-datepicker-toggle>
                                <mat-datepicker #picker9></mat-datepicker>
                            </mat-form-field>
                        </div>

                        <!-- 4 -->
                        <div class="col-md-3">
                            <mat-form-field style="display: none;" class="w-100 payment4">
                                <mat-label>{{'Policy.paymentDate4'|translate}}</mat-label>
                                <input  formControlName="Settlement4" matInput [matDatepicker]="picker10">
                                <mat-datepicker-toggle matIconSuffix [for]="picker10"></mat-datepicker-toggle>
                                <mat-datepicker #picker10></mat-datepicker>
                            </mat-form-field>
                        </div>
                    </div>
                </form>
                <hr style="width:80%; margin:auto;border-top:1px solid;color:#000" class="my-4">
                <div class="d-flex justify-content-end">
                    <button color="warn" mat-raised-button matStepperNext>{{'Shared.Next'|translate}}</button>
                </div>
                    </mat-step>
                    
                    
                <!---------------------------- Plans -------------------->
                <mat-step label="{{'Offer.Plans'|translate}}" [completed]="this.OfferPlans.length!=0">
                    <!--  -->
                    <button (click)="showNewPlan()" mat-stroked-button color="warn" class="my-2">{{'Shared.AddNew'|translate}}</button>
                    <div style="display: none;" id="AddPlan">
                        <form [formGroup]="PlanForm">
                            <div class="row">
                                <div class="col-md-6 my-3">
                                    <table class="table table-striped table-bordered text-center mt-2" style="border-radius: 20px;">
                                        <tbody class="align-middle">
                                            <tr>
                                                <th class="w-30 py-3">Upload Plans File</th>
                                                <td class="w-60 py-3">
                                                    <i (click)="fileInput.click()" class="fa-solid fa-cloud-arrow-up fs-2 px-2 py-2" style="color:#3F51B5;border-radius: 5px;"></i>
                                                    <input accept=".xlsx , .pdf" hidden (change)="uploadPlanFile($event)" #fileInput type="file">
                                                    <span class="file-name">{{selectedPlanFile?.name}}</span>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="row ">
                                <div class="col-md-3">
                                    <mat-form-field class="w-100" >
                                        <mat-label>{{'Offer.PlanName'|translate}}</mat-label>
                                        <mat-select formControlName="PlanName">
                                            <mat-option value="A">A</mat-option>
                                            <mat-option value="B">B</mat-option>
                                            <mat-option value="C">C</mat-option>
                                            <mat-option value="D">D</mat-option>
                                            <mat-option value="E">E</mat-option>
                                            <mat-option value="F">F</mat-option>
                                            <mat-option value="G">G</mat-option>
                                            <mat-option value="H">H</mat-option>
                                            <mat-option value="I">I</mat-option>
                                            <mat-option value="J">J</mat-option>
                                        </mat-select>
                                    </mat-form-field>

                                </div>
                                <div class="col-md-3">
                                    <mat-form-field class="w-100">
                                        <mat-label>{{'Offer.NetPremium'|translate}}</mat-label>
                                        <input formControlName="NetPremium" type="number" matInput>
                                    </mat-form-field>
                                </div>
                                <div class="col-md-3">
                                    <mat-form-field class="w-100">
                                        <mat-label>{{'Offer.AnnualMaxLimit'|translate}}</mat-label>
                                        <input formControlName="AnnualMaxLimit" type="number" matInput>
                                    </mat-form-field>
                                </div>
                                <div class="col-md-3 d-flex justify-content-end">
                                    <button [disabled]="this.PlanForm.status=='INVALID'" (click)="view()" mat-raised-button color="accent" class="mt-2">{{'Shared.Add'|translate}}</button>
                                </div>

                            </div>
                        </form>
                    </div>
                    <div *ngIf="this.OfferPlans?.length==0"  class="alert alert-info w-75 my-5 m-auto text-center fs-5"><strong>{{'Offer.NoPlansYet'|translate}}</strong></div>
                    <div style="max-height:19rem;overflow: auto;" >
                        <table *ngIf="this.OfferPlans.length>0" class="table table-striped text-center">
                            <thead>
                                    <th>{{'Offer.PlanName'|translate}}</th>
                                    <th>{{'Offer.NetPremium'|translate}}</th>
                                    <th>{{'Offer.AnnualMaxLimit'|translate}}</th>
                                    <th>{{'Offer.File'|translate}}</th>
                                    <th></th>
                            </thead>
                            <tbody>
                                    <tr *ngFor="let plan of this.OfferPlans;let index = index">
                                        <td>{{plan.planName}}</td>
                                        <td>{{plan.netPremium}}</td>
                                        <td>{{plan.annualMaxLimit}}</td>
                                        <td>{{plan.fileName}}</td>
                                        <td><button color="warn" (click)="remove(index,plan.id,plan.planName)" mat-raised-button>{{'Shared.Remove'|translate}}</button></td>
                                    </tr>
                            </tbody>
                        </table>
                    </div>
                    <!--  -->
                    <hr style="width:80%; margin:auto;border-top:1px solid;color:#000" class="my-4">
                    <div class="d-flex justify-content-between">
                        <div>
                          <button color="accent"  mat-raised-button matStepperPrevious >{{'Shared.Previous'|translate}}</button>
                        </div>
                        <div>
                          <button color="warn"  mat-raised-button matStepperNext>{{'Shared.Next'|translate}}</button>
                        </div>
                    </div>
                </mat-step>
                <!----------------------------- Group ------------------------->
                <mat-step label="{{'Offer.Group'|translate}}">
                    <div class="row">
                        <div class="col-md-9">
                            <table class="table table-striped table-bordered text-center">
                                <tbody>
                                    <tr>
                                        <th class="w-30 align-middle fs-6">{{'Shared.downloadTemplete'|translate}}</th>
                                        <td class="w-60 align-middle">
                                            <div class="Download">
                                                <i (click)="getTempleteFile()" class="text-success fa-solid fa-download fs-3 px-2 py-1 mt-3" style="border-radius: 7px;"></i>
                                                <!-- <i  class="text-success fa-solid fa-spinner fa-spin fs-3 px-2 py-1 mt-2"></i> -->
                                            </div>
                                        </td>
                                    </tr>
                
                                    <tr>
                                        <th class="w-30  align-middle fs-6">{{'Shared.Upload'|translate}} {{'Shared.Group'|translate}}</th>
                                        <td class="w-60  align-middle">
                                            <div>
                                                <i (click)="fileGroupInput.click()" class="fa-solid fa-cloud-arrow-up fs-2 px-2 py-2" style="color:#3F51B5;border-radius: 5px;cursor: pointer;"></i>
                                                <input accept=".xlsx" hidden (change)="uploadGroupFile($event)" #fileGroupInput type="file">
                                                <span class="file-name">{{selectedGroupFile?.name}}</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex justify-content-end">
                                <button *ngIf="this.OfferGroup?.length>0" mat-stroked-button color="warn" class="my-2"(click)=showCurrentGroup()>{{"Offer.CurrerntGroup"|translate}}</button>
                            </div>
                        </div>
                    </div>
                    
                    <div *ngIf="this.OfferGroup?.length==0"  class="alert alert-info w-75 my-5 m-auto text-center fs-5"><strong>{{'Offer.NoCustomerGroupYet'|translate}}</strong></div>
                    <div *ngIf="this.OfferGroup?.length>0" style="display:none; max-height:19rem;overflow: auto;" id="currentGroup">
                        <table class="table table-striped text-center">
                            <thead>
                                <th>{{'addCustomer.Name'|translate}}</th>
                                <th>{{'addCustomer.Sex'|translate}}</th>
                                <th>{{'Offer.GroupRel'|translate}}</th>
                                <th>{{'addCustomer.D.O.B'|translate}}</th>
                                <th>{{'Shared.Age'|translate}}</th>
                                <th>{{'addCustomer.Notes'|translate}}</th>
                                </thead>
                            <tbody>
                                <tr *ngFor="let gruop of this.OfferGroup;">
                                    <td>{{gruop.name}}</td>
                                    <td>{{gruop.gender}}</td>
                                    <td>{{gruop.groupRel}}</td>
                                    <td>{{gruop.dateOfBirth|date:'dd-MM-yyyy'}}</td>
                                    <td>{{gruop.age}}</td>
                                    <td><span *ngIf="gruop.notes==''">_</span>{{gruop.notes}}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    

                    <hr style="width:80%; margin:auto;border-top:1px solid;color:#000" class="my-4">
                    <div class="d-flex justify-content-between">
                        <div>
                          <button color="accent" mat-raised-button matStepperPrevious>{{'Shared.Previous'|translate}}</button>
                        </div>
                        <div>
                          
                          <button (click)="SaveUpdate()" [disabled]="this.MainForm.status=='INVALID'" color="primary" mat-raised-button matStepperNext ><span *ngIf="this.isLoading">{{'Shared.Waiting'|translate}}</span> <span *ngIf="!this.isLoading">{{'Shared.Submit'|translate}}</span></button>
                        </div>
                    </div>
                </mat-step>
                </mat-horizontal-stepper>
        </div>
    </div>
</div>